# XcodeGen project specification for Drawing Mobile - JIT Device
# Generate with: ./generate-project.sh project-jit-device.yml or via Makefile
#
# JIT MODE: App namespaces are loaded via remote compile server!
# Only core libs (clojure.core, etc.) are bundled. No app modules.
# Requires: compile-server running on macOS before loading app namespaces.
#
# NOTE: Device JIT requires debugger attachment (free Apple Developer account limitation).
#
# Environment variables (set by generate-project.sh or Makefile):
#   JANK_SRC - Path to jank compiler+runtime
#              Default: /Users/pfeodrippe/dev/jank/compiler+runtime

name: DrawingMobile-JIT-Device

include:
  - config-common.yml

settings:
  base:
    PRODUCT_NAME: DrawingMobile-JIT-Device
    GCC_PREPROCESSOR_DEFINITIONS:
      - JANK_TARGET_IOS=1
      - JANK_IOS_JIT=1
      - IMMER_HAS_LIBGC=1
      - IMMER_TAGGED_NODE=0

targets:
  DrawingMobile-JIT-Device:
    type: application
    platform: iOS
    deploymentTarget: "17.0"
    templates: [CommonSources, JITResources]
    sources:
      # JIT-specific sources (device version)
      - path: build-iphoneos-jit/generated/jank_aot_init.cpp
        compilerFlags: ["-x", "c++"]
      # NOTE: No PCH for device (Mac paths don't work on device)
      # .clang-format needed for native-source formatting
      - path: jank-resources/.clang-format
        buildPhase: resources
    settings:
      groups: [CommonCodeSign]
      base:
        INFOPLIST_FILE: Info.plist
        TARGETED_DEVICE_FAMILY: "1,2"  # iPhone and iPad
        IPHONEOS_DEPLOYMENT_TARGET: "17.0"
        CODE_SIGN_ENTITLEMENTS: jank-jit.entitlements
        CODE_SIGN_ALLOW_ENTITLEMENTS_MODIFICATION: YES
        # All headers (groups don't merge arrays!)
        HEADER_SEARCH_PATHS:
          - $(PROJECT_DIR)/../vendor/imgui
          - $(PROJECT_DIR)/../vendor/imgui/backends
          - $(PROJECT_DIR)/../vendor/flecs/distr
          - $(PROJECT_DIR)/../vendor
          - $(PROJECT_DIR)/Frameworks/include
          - $(PROJECT_DIR)/Frameworks/include/SDL3
          # Metal renderer native headers
          - $(PROJECT_DIR)/jank-resources/src/jank
          - ${JANK_SRC}/include/cpp
          - ${JANK_SRC}/src/cpp
          - ${JANK_SRC}/third-party/immer
          - ${JANK_SRC}/third-party/bdwgc/include
          - ${JANK_SRC}/third-party/boost-preprocessor/include
          - ${JANK_SRC}/third-party/boost-multiprecision/include
          - ${JANK_SRC}/third-party/folly
          - ${JANK_SRC}/third-party/stduuid/include
          # JIT-specific LLVM headers (DEVICE version)
          - ${HOME}/dev/ios-llvm-build/ios-llvm-device/include
          - ${JANK_SRC}/third-party/cppinterop/include
        FRAMEWORK_SEARCH_PATHS:
          - $(PROJECT_DIR)/Frameworks
        LD_RUNPATH_SEARCH_PATHS:
          - "@executable_path/Frameworks"
        LIBRARY_SEARCH_PATHS:
          - $(PROJECT_DIR)/build-iphoneos-jit
        OTHER_LDFLAGS:
          # Common frameworks
          - "-framework Metal"
          - "-framework MetalKit"
          - "-framework QuartzCore"
          - "-framework UIKit"
          - "-framework Foundation"
          - "-framework CoreGraphics"
          - "-framework CoreVideo"
          - "-framework AVFoundation"
          - "-framework Photos"
          - "-framework PhotosUI"
          - "-framework GameController"
          - "-framework CoreHaptics"
          - "-framework CoreMotion"
          - "-framework IOSurface"
          - "-framework IOKit"
          - "-lc++"
          # JIT libraries (device version, core libs only)
          - "-Wl,-force_load,$(PROJECT_DIR)/build-iphoneos-jit/libjank.a"
          - "-ljankzip"
          - "-lgc"
          - "-lfolly"
          - "-ljank_aot"
          - "-lllvm_merged"
          - "-lcurses"
          - "-lz"

schemes:
  DrawingMobile-JIT-Device:
    build:
      targets:
        DrawingMobile-JIT-Device: all
    run:
      config: Debug
    test:
      config: Debug
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
