<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>La Voiture - Interactive Fiction</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0d0d0f;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: sans-serif;
        }
        #canvas {
            width: 1280px;
            height: 720px;
        }
        #status {
            color: #888;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div>
        <canvas id="canvas" width="1280" height="720"></canvas>
        <div id="status">Loading...</div>
    </div>
    <script type="module">
        import fiction from './fiction.js';
        
        const canvas = document.getElementById('canvas');
        const status = document.getElementById('status');
        
        status.textContent = 'Loading WASM runtime...';

        function updateStatusFromRuntimeLine(line) {
            if (line.includes('[fiction-wasm] Requesting WebGPU adapter')) {
                status.textContent = 'Requesting WebGPU adapter...';
            } else if (line.includes('[fiction-wasm] Adapter acquired')) {
                status.textContent = 'Adapter acquired, requesting device...';
            } else if (line.includes('[fiction-wasm] Device ready, engine initialized')) {
                status.textContent = 'Running';
            } else if (
                line.includes('Failed to get WebGPU adapter') ||
                line.includes('Failed to get WebGPU device') ||
                line.includes('Timeout waiting for WebGPU device') ||
                line.includes('WebGPU initialization failed')
            ) {
                status.textContent = 'WebGPU init failed. Check console logs.';
            }
        }
        
        fiction({
            canvas: canvas,
            // Help emscripten find the .data file with preloaded assets
            locateFile: function(path) {
                return './' + path;
            },
            print: function(text) {
                console.log(text);
                updateStatusFromRuntimeLine(text);
            },
            printErr: function(text) {
                console.error(text);
                updateStatusFromRuntimeLine(text);
            },
            onRuntimeInitialized: function() {
                status.textContent = 'Runtime initialized, starting game loop...';
            }
        }).then(module => {
            // The fiction main loop usually never returns.
            status.textContent = 'Runtime exited';

            // Debug: list files in virtual filesystem (if FS is exported)
            if (module.FS && module.FS.readdir) {
                console.log('[debug] FS root:', module.FS.readdir('/'));
                if (module.FS.analyzePath('/stories').exists) {
                    console.log('[debug] /stories:', module.FS.readdir('/stories'));
                }
            } else {
                console.log('[debug] FS not exported, skipping filesystem debug');
            }
        }).catch(err => {
            status.textContent = 'Error: ' + err.message;
            console.error(err);
        });
    </script>
</body>
</html>
