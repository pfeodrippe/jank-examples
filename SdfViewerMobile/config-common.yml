# Common configuration shared across all iOS project variants
# Include this file in project-*.yml files
#
# Usage in project files:
#   include:
#     - config-common.yml
#   targets:
#     MyTarget:
#       templates: [CommonSources]
#       settings:
#         groups: [CommonHeaders, CommonFrameworks]

# ============================================================================
# Common Options
# ============================================================================
options:
  bundleIdPrefix: com.vybe
  deploymentTarget:
    iOS: "17.0"
  xcodeVersion: "15.0"
  generateEmptyDirectories: true
  groupSortPosition: top

# ============================================================================
# Common Settings
# ============================================================================
settings:
  base:
    MARKETING_VERSION: "1.0.0"
    CURRENT_PROJECT_VERSION: "1"
    DEVELOPMENT_TEAM: "GNRTKYX7C4"
    CODE_SIGN_STYLE: Automatic
    ENABLE_BITCODE: NO
    CLANG_CXX_LANGUAGE_STANDARD: c++20
    CLANG_CXX_LIBRARY: libc++

# ============================================================================
# Setting Groups (reusable build settings)
# ============================================================================
settingGroups:
  CommonHeaders:
    HEADER_SEARCH_PATHS:
      - $(PROJECT_DIR)/../vendor/imgui
      - $(PROJECT_DIR)/../vendor/imgui/backends
      - $(PROJECT_DIR)/../vendor/flecs/distr
      - $(PROJECT_DIR)/../vendor
      - $(PROJECT_DIR)/../vulkan
      - $(PROJECT_DIR)/Frameworks/include
      - $(PROJECT_DIR)/Frameworks/include/SDL3
      - $(PROJECT_DIR)/Frameworks/include/vulkan
      - $(PROJECT_DIR)/Frameworks/include/MoltenVK
      # jank headers (uses JANK_SRC env var, substituted at xcodegen time)
      - ${JANK_SRC}/include/cpp
      - ${JANK_SRC}/src/cpp
      - ${JANK_SRC}/third-party/immer
      - ${JANK_SRC}/third-party/bdwgc/include
      - ${JANK_SRC}/third-party/boost-preprocessor/include
      - ${JANK_SRC}/third-party/boost-multiprecision/include
      - ${JANK_SRC}/third-party/folly
      - ${JANK_SRC}/third-party/stduuid/include
    FRAMEWORK_SEARCH_PATHS:
      - $(PROJECT_DIR)/Frameworks
    LD_RUNPATH_SEARCH_PATHS:
      - "@executable_path/Frameworks"

  # NOTE: CommonFrameworks removed - XcodeGen settingGroups don't merge arrays,
  # they replace them. So OTHER_LDFLAGS must be specified fully in each target.
  # The frameworks are now specified directly in each project file.

  CommonCodeSign:
    CODE_SIGN_IDENTITY: "Apple Development"
    CODE_SIGNING_REQUIRED: "YES"
    CODE_SIGNING_ALLOWED: "YES"

  JITHeaders:
    # Additional headers for JIT builds (LLVM/Clang)
    # Note: Override with simulator or device path as needed
    HEADER_SEARCH_PATHS:
      - ${JANK_SRC}/third-party/cppinterop/include

# ============================================================================
# Target Templates
# ============================================================================
targetTemplates:
  CommonSources:
    sources:
      - path: main.mm
        compilerFlags: ["-x", "objective-c++"]
      - path: sdf_viewer_ios.mm
        compilerFlags: ["-x", "objective-c++"]
      # ImGui sources
      - path: ../vendor/imgui/imgui.cpp
      - path: ../vendor/imgui/imgui_draw.cpp
      - path: ../vendor/imgui/imgui_widgets.cpp
      - path: ../vendor/imgui/imgui_tables.cpp
      - path: ../vendor/imgui/backends/imgui_impl_vulkan.cpp
      - path: ../vendor/imgui/backends/imgui_impl_sdl3.cpp
      # STB implementation
      - path: ../vulkan/stb_impl.c
      # Flecs ECS (needed for vybe.type and vybe.flecs)
      - path: ../vendor/flecs/distr/flecs.c
        compilerFlags: ["-O2"]
      # Vybe Flecs helpers (needed for vybe.flecs jank bindings)
      - path: ../vendor/vybe/vybe_flecs_jank.cpp
        compilerFlags: ["-O2"]
      # SDF engine implementation (compiled once to avoid duplicate symbols)
      - path: sdf_engine_impl.cpp
        compilerFlags: ["-x", "c++"]
      # Common resources (bundled with app)
      - path: LaunchScreen.storyboard
        buildPhase: resources
      - path: vulkan_kim
        buildPhase: resources
        type: folder
      - path: exported_scene.glb
        buildPhase: resources
        optional: true
    dependencies:
      - framework: Frameworks/MoltenVK.xcframework
        embed: true
      - framework: Frameworks/SDL3.xcframework
        embed: true
    preBuildScripts:
      - name: Compile Shaders
        script: |
          echo "Checking shaders..."
          SHADER_DIR="${PROJECT_DIR}/../vulkan_kim"
          if command -v glslangValidator &> /dev/null; then
            for shader in "$SHADER_DIR"/*.comp; do
              if [ -f "$shader" ]; then
                spv="${shader%.comp}.spv"
                if [ ! -f "$spv" ] || [ "$shader" -nt "$spv" ]; then
                  echo "Compiling $(basename "$shader")..."
                  glslangValidator -V "$shader" -o "$spv"
                fi
              fi
            done
          fi

  # JIT-specific resources template
  JITResources:
    sources:
      # jank resources for JIT (bundled with app)
      - path: jank-resources/src
        buildPhase: resources
        type: folder
      - path: jank-resources/include
        buildPhase: resources
        type: folder
      - path: jank-resources/clang
        buildPhase: resources
        type: folder
    entitlements:
      path: jank-jit.entitlements
