# XcodeGen project specification for SDF Viewer Mobile - JIT-ONLY Version (Simulator)
# Generate with: ./generate-project.sh project-jit-only-sim.yml or via Makefile
#
# JIT-ONLY MODE: App namespaces are loaded via remote compile server!
# Only core libs (clojure.core, etc.) are bundled. No app modules.
# Requires: compile-server running on macOS before loading app namespaces.
#
# Environment variables (set by generate-project.sh or Makefile):
#   JANK_SRC - Path to jank compiler+runtime
#              Default: /Users/pfeodrippe/dev/jank/compiler+runtime

name: SdfViewerMobile-JIT-Only

options:
  bundleIdPrefix: com.vybe
  deploymentTarget:
    iOS: "17.0"
  xcodeVersion: "15.0"
  generateEmptyDirectories: true
  groupSortPosition: top

settings:
  base:
    PRODUCT_NAME: SdfViewerMobile-JIT-Only
    MARKETING_VERSION: "1.0.0"
    CURRENT_PROJECT_VERSION: "1"
    DEVELOPMENT_TEAM: "937QJHK26U"
    CODE_SIGN_STYLE: Automatic
    ENABLE_BITCODE: NO
    CLANG_CXX_LANGUAGE_STANDARD: c++20
    CLANG_CXX_LIBRARY: libc++
    GCC_PREPROCESSOR_DEFINITIONS:
      - VK_USE_PLATFORM_IOS_MVK=1
      - VK_USE_PLATFORM_METAL_EXT=1
      - JANK_TARGET_IOS=1
      - JANK_IOS_JIT=1
      - IMMER_HAS_LIBGC=1
      - IMMER_TAGGED_NODE=0
      # NO SDF_AOT_BUILD - we use JIT-only mode with remote compile server!

targets:
  SdfViewerMobile-JIT-Only:
    type: application
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: main.mm
        compilerFlags: ["-x", "objective-c++"]
      - path: sdf_viewer_ios.mm
        compilerFlags: ["-x", "objective-c++"]
      # ImGui sources
      - path: ../vendor/imgui/imgui.cpp
      - path: ../vendor/imgui/imgui_draw.cpp
      - path: ../vendor/imgui/imgui_widgets.cpp
      - path: ../vendor/imgui/imgui_tables.cpp
      - path: ../vendor/imgui/backends/imgui_impl_vulkan.cpp
      - path: ../vendor/imgui/backends/imgui_impl_sdl3.cpp
      # STB implementation
      - path: ../vulkan/stb_impl.c
      # Flecs ECS (needed for vybe.type and vybe.flecs)
      - path: ../vendor/flecs/distr/flecs.c
        compilerFlags: ["-O2"]
      # Vybe Flecs helpers (needed for vybe.flecs jank bindings)
      - path: ../vendor/vybe/vybe_flecs_jank.cpp
        compilerFlags: ["-O2"]
      # SDF engine implementation
      - path: sdf_engine_impl.cpp
        compilerFlags: ["-x", "c++"]
      # JIT-only jank_aot_init - only loads core libs, NOT app modules
      - path: build-iphonesimulator-jit/generated/jank_aot_init.cpp
        compilerFlags: ["-x", "c++"]
      # Resources
      - path: LaunchScreen.storyboard
        buildPhase: resources
      - path: vulkan_kim
        buildPhase: resources
        type: folder
      - path: exported_scene.glb
        buildPhase: resources
      # jank resources for JIT (bundled with app)
      - path: jank-resources/src
        buildPhase: resources
        type: folder
      - path: jank-resources/include
        buildPhase: resources
        type: folder
      - path: jank-resources/clang
        buildPhase: resources
        type: folder
      - path: jank-resources/incremental.pch
        buildPhase: resources
    entitlements:
      path: jank-jit.entitlements
    settings:
      base:
        INFOPLIST_FILE: Info.plist
        TARGETED_DEVICE_FAMILY: "2"  # iPad only (for simulator)
        IPHONEOS_DEPLOYMENT_TARGET: "17.0"
        CODE_SIGN_ENTITLEMENTS: jank-jit.entitlements
        CODE_SIGN_ALLOW_ENTITLEMENTS_MODIFICATION: YES
        HEADER_SEARCH_PATHS:
          - $(PROJECT_DIR)/../vendor/imgui
          - $(PROJECT_DIR)/../vendor/imgui/backends
          - $(PROJECT_DIR)/../vendor/flecs/distr
          - $(PROJECT_DIR)/../vendor
          - $(PROJECT_DIR)/../vulkan
          - $(PROJECT_DIR)/Frameworks/include
          - $(PROJECT_DIR)/Frameworks/include/SDL3
          - $(PROJECT_DIR)/Frameworks/include/vulkan
          - $(PROJECT_DIR)/Frameworks/include/MoltenVK
          # jank headers (uses JANK_SRC env var, substituted at xcodegen time)
          - ${JANK_SRC}/include/cpp
          - ${JANK_SRC}/src/cpp
          - ${JANK_SRC}/third-party/immer
          - ${JANK_SRC}/third-party/bdwgc/include
          - ${JANK_SRC}/third-party/bpptree/include
          - ${JANK_SRC}/third-party/boost-preprocessor/include
          - ${JANK_SRC}/third-party/boost-multiprecision/include
          - ${JANK_SRC}/third-party/folly
          - ${JANK_SRC}/third-party/stduuid/include
          # LLVM/Clang headers for JIT (SIMULATOR version)
          - ${HOME}/dev/ios-llvm-build/ios-llvm-simulator/include
          - ${JANK_SRC}/third-party/cppinterop/include
        FRAMEWORK_SEARCH_PATHS:
          - $(PROJECT_DIR)/Frameworks
        LIBRARY_SEARCH_PATHS:
          # JIT-specific build directory (SIMULATOR version)
          - $(PROJECT_DIR)/build-iphonesimulator-jit
        LD_RUNPATH_SEARCH_PATHS:
          - "@executable_path/Frameworks"
        OTHER_LDFLAGS:
          - "-framework Metal"
          - "-framework MetalKit"
          - "-framework QuartzCore"
          - "-framework UIKit"
          - "-framework Foundation"
          - "-framework CoreGraphics"
          - "-framework CoreVideo"
          - "-framework AVFoundation"
          - "-framework GameController"
          - "-framework CoreHaptics"
          - "-framework CoreMotion"
          - "-framework IOSurface"
          - "-framework IOKit"
          - "-lc++"
          # Force load jank symbols for JIT resolution (SIMULATOR version)
          - "-Wl,-force_load,$(PROJECT_DIR)/build-iphonesimulator-jit/libjank.a"
          - "-ljankzip"
          - "-lgc"
          - "-lfolly"
          # JIT-ONLY: Only core libs, NO app modules!
          # libjank_aot.a contains: core libs + jank_aot_init.o (core-only version)
          - "-ljank_aot"
          # Merged LLVM library (all LLVM/Clang/CppInterOp static libs)
          - "-lllvm_merged"
          # System libraries needed by LLVM
          - "-lcurses"
          - "-lz"
        CODE_SIGN_IDENTITY: "Apple Development"
        CODE_SIGNING_REQUIRED: "YES"
        CODE_SIGNING_ALLOWED: "YES"
    dependencies:
      - framework: Frameworks/MoltenVK.xcframework
        embed: true
      - framework: Frameworks/SDL3.xcframework
        embed: true
    preBuildScripts:
      - name: Compile Shaders
        script: |
          echo "Checking shaders..."
          SHADER_DIR="${PROJECT_DIR}/../vulkan_kim"
          if command -v glslangValidator &> /dev/null; then
            for shader in "$SHADER_DIR"/*.comp; do
              if [ -f "$shader" ]; then
                spv="${shader%.comp}.spv"
                if [ ! -f "$spv" ] || [ "$shader" -nt "$spv" ]; then
                  echo "Compiling $(basename "$shader")..."
                  glslangValidator -V "$shader" -o "$spv"
                fi
              fi
            done
          fi

schemes:
  SdfViewerMobile-JIT-Only:
    build:
      targets:
        SdfViewerMobile-JIT-Only: all
    run:
      config: Debug
    test:
      config: Debug
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
