# XcodeGen project specification for SDF Viewer Mobile
# Generate Xcode project with: xcodegen generate
# Install xcodegen: brew install xcodegen

name: SdfViewerMobile

options:
  bundleIdPrefix: com.vybe
  deploymentTarget:
    iOS: "17.0"  # Required for jank C++20 features (std::format)
  xcodeVersion: "15.0"
  generateEmptyDirectories: true
  groupSortPosition: top

settings:
  base:
    PRODUCT_NAME: SdfViewerMobile
    MARKETING_VERSION: "1.0.0"
    CURRENT_PROJECT_VERSION: "1"
    DEVELOPMENT_TEAM: "937QJHK26U"
    CODE_SIGN_STYLE: Automatic
    ENABLE_BITCODE: NO
    CLANG_CXX_LANGUAGE_STANDARD: c++20
    CLANG_CXX_LIBRARY: libc++
    GCC_PREPROCESSOR_DEFINITIONS:
      - VK_USE_PLATFORM_IOS_MVK=1
      - VK_USE_PLATFORM_METAL_EXT=1
      - JANK_TARGET_IOS=1
      - JANK_TARGET_WASM=1
      - JANK_TARGET_EMSCRIPTEN=1
      - IMMER_HAS_LIBGC=1
      - IMMER_TAGGED_NODE=0
      - SDF_AOT_BUILD=1

targets:
  SdfViewerMobile:
    type: application
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: main.mm
        compilerFlags: ["-x", "objective-c++"]
      - path: sdf_viewer_ios.mm
        compilerFlags: ["-x", "objective-c++"]
      # ImGui sources
      - path: ../vendor/imgui/imgui.cpp
      - path: ../vendor/imgui/imgui_draw.cpp
      - path: ../vendor/imgui/imgui_widgets.cpp
      - path: ../vendor/imgui/imgui_tables.cpp
      - path: ../vendor/imgui/backends/imgui_impl_vulkan.cpp
      - path: ../vendor/imgui/backends/imgui_impl_sdl3.cpp
      # STB implementation
      - path: ../vulkan/stb_impl.c
      # SDF engine implementation (compiled once to avoid duplicate symbols)
      - path: sdf_engine_impl.cpp
        compilerFlags: ["-x", "c++"]
      # jank AOT-compiled modules - linked as pre-compiled objects (see OTHER_LDFLAGS)
      # generated/vybe_sdf_generated.cpp is compiled by build_ios_jank_aot.sh
      # Resources (bundled with app)
      - path: LaunchScreen.storyboard
        buildPhase: resources
      - path: vulkan_kim
        buildPhase: resources
        type: folder
      - path: exported_scene.glb
        buildPhase: resources
    settings:
      base:
        INFOPLIST_FILE: Info.plist
        TARGETED_DEVICE_FAMILY: "2"  # iPad only
        IPHONEOS_DEPLOYMENT_TARGET: "17.0"
        # Include paths
        HEADER_SEARCH_PATHS:
          - $(PROJECT_DIR)/../vendor/imgui
          - $(PROJECT_DIR)/../vendor/imgui/backends
          - $(PROJECT_DIR)/../vendor/flecs/distr
          - $(PROJECT_DIR)/../vendor
          - $(PROJECT_DIR)/../vulkan
          - $(PROJECT_DIR)/Frameworks/include
          - $(PROJECT_DIR)/Frameworks/include/SDL3
          - $(PROJECT_DIR)/Frameworks/include/vulkan
          - $(PROJECT_DIR)/Frameworks/include/MoltenVK
          # jank headers
          - /Users/pfeodrippe/dev/jank/compiler+runtime/include/cpp
          - /Users/pfeodrippe/dev/jank/compiler+runtime/src/cpp
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/immer
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/bdwgc/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/bpptree/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/boost-preprocessor/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/boost-multiprecision/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/folly
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/stduuid/include
        FRAMEWORK_SEARCH_PATHS:
          - $(PROJECT_DIR)/Frameworks
        LIBRARY_SEARCH_PATHS:
          - $(PROJECT_DIR)/build-$(PLATFORM_NAME)
          - /Users/pfeodrippe/dev/jank/compiler+runtime/build-ios-simulator
          - /Users/pfeodrippe/dev/jank/compiler+runtime/build-ios-simulator/third-party/bdwgc
          - /Users/pfeodrippe/dev/jank/compiler+runtime/build-ios
          - /Users/pfeodrippe/dev/jank/compiler+runtime/build-ios/third-party/bdwgc
        LD_RUNPATH_SEARCH_PATHS:
          - "@executable_path/Frameworks"
        # Linker flags
        OTHER_LDFLAGS:
          - "-framework Metal"
          - "-framework MetalKit"
          - "-framework QuartzCore"
          - "-framework UIKit"
          - "-framework Foundation"
          - "-framework CoreGraphics"
          - "-framework CoreVideo"
          - "-framework AVFoundation"
          - "-framework GameController"
          - "-framework CoreHaptics"
          - "-framework CoreMotion"
          - "-framework IOSurface"
          - "-framework IOKit"
          - "-lc++"
          # jank runtime libraries
          - "-ljank"
          - "-ljankzip"
          - "-lgc"
          # jank core library object files (pre-compiled)
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/clojure_core_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/clojure_set_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/clojure_string_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/clojure_walk_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/clojure_template_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/clojure_test_generated.o"
          # vybe.sdf modules (in dependency order)
          # Dependencies must be loaded in order: util -> math -> state -> shader -> ui -> ios
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/vybe_util_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/vybe_sdf_math_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/vybe_sdf_state_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/vybe_sdf_shader_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/vybe_sdf_ui_generated.o"
          - "$(PROJECT_DIR)/build-$(PLATFORM_NAME)/obj/vybe_sdf_ios_generated.o"
        # Code signing - automatic for device, none for simulator
        CODE_SIGN_IDENTITY: "Apple Development"
        CODE_SIGNING_REQUIRED: "YES"
        CODE_SIGNING_ALLOWED: "YES"
    dependencies:
      - framework: Frameworks/MoltenVK.xcframework
        embed: true
      - framework: Frameworks/SDL3.xcframework
        embed: true
    preBuildScripts:
      - name: Compile Shaders
        script: |
          echo "Checking shaders..."
          SHADER_DIR="${PROJECT_DIR}/../vulkan_kim"
          if command -v glslangValidator &> /dev/null; then
            for shader in "$SHADER_DIR"/*.comp; do
              if [ -f "$shader" ]; then
                spv="${shader%.comp}.spv"
                if [ ! -f "$spv" ] || [ "$shader" -nt "$spv" ]; then
                  echo "Compiling $(basename "$shader")..."
                  glslangValidator -V "$shader" -o "$spv"
                fi
              fi
            done
          fi

schemes:
  SdfViewerMobile:
    build:
      targets:
        SdfViewerMobile: all
    run:
      config: Debug
    test:
      config: Debug
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
