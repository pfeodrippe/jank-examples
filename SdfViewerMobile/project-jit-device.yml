# XcodeGen project specification for SDF Viewer Mobile - JIT Version (Device)
# Generate Xcode project with: xcodegen generate --spec project-jit-device.yml --project SdfViewerMobile-JIT-Device
#
# IMPORTANT: JIT only works when launched from Xcode!
# This build includes LLVM for runtime compilation on physical devices.

name: SdfViewerMobile-JIT-Device

options:
  bundleIdPrefix: com.vybe
  deploymentTarget:
    iOS: "17.0"
  xcodeVersion: "15.0"
  generateEmptyDirectories: true
  groupSortPosition: top

settings:
  base:
    PRODUCT_NAME: SdfViewerMobile-JIT-Device
    MARKETING_VERSION: "1.0.0"
    CURRENT_PROJECT_VERSION: "1"
    DEVELOPMENT_TEAM: "937QJHK26U"
    CODE_SIGN_STYLE: Automatic
    ENABLE_BITCODE: NO
    CLANG_CXX_LANGUAGE_STANDARD: c++20
    CLANG_CXX_LIBRARY: libc++
    GCC_PREPROCESSOR_DEFINITIONS:
      - VK_USE_PLATFORM_IOS_MVK=1
      - VK_USE_PLATFORM_METAL_EXT=1
      - JANK_TARGET_IOS=1
      - JANK_IOS_JIT=1
      - IMMER_HAS_LIBGC=1
      - IMMER_TAGGED_NODE=0
      # NO SDF_AOT_BUILD - we use JIT!

targets:
  SdfViewerMobile-JIT-Device:
    type: application
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: main.mm
        compilerFlags: ["-x", "objective-c++"]
      - path: sdf_viewer_ios.mm
        compilerFlags: ["-x", "objective-c++"]
      # ImGui sources
      - path: ../vendor/imgui/imgui.cpp
      - path: ../vendor/imgui/imgui_draw.cpp
      - path: ../vendor/imgui/imgui_widgets.cpp
      - path: ../vendor/imgui/imgui_tables.cpp
      - path: ../vendor/imgui/backends/imgui_impl_vulkan.cpp
      - path: ../vendor/imgui/backends/imgui_impl_sdl3.cpp
      # STB implementation
      - path: ../vulkan/stb_impl.c
      # SDF engine implementation
      - path: sdf_engine_impl.cpp
        compilerFlags: ["-x", "c++"]
      # jank_aot_init must be compiled by Xcode (not from libvybe_aot.a) to get JANK_IOS_JIT defined
      # This enables nREPL loading for JIT mode
      - path: build-iphoneos-jit/generated/jank_aot_init.cpp
        compilerFlags: ["-x", "c++"]
      # Resources
      - path: LaunchScreen.storyboard
        buildPhase: resources
      - path: vulkan_kim
        buildPhase: resources
        type: folder
      - path: exported_scene.glb
        buildPhase: resources
      # jank resources for JIT (bundled with app)
      # src/jank/ - jank source files (clojure.core, etc.)
      - path: jank-resources/src
        buildPhase: resources
        type: folder
      # include/ - jank C++ headers for JIT compilation
      - path: jank-resources/include
        buildPhase: resources
        type: folder
      # clang/ - clang resource directory (compiler headers)
      - path: jank-resources/clang
        buildPhase: resources
        type: folder
      # NOTE: PCH is NOT bundled for device builds!
      # The PCH built on Mac has Mac filesystem paths embedded, which causes
      # redefinition errors when JIT runs on device (device can't access Mac filesystem).
      # The JIT fallback code will parse the prelude header at runtime instead.
    entitlements:
      path: jank-jit.entitlements
    settings:
      base:
        INFOPLIST_FILE: Info.plist
        TARGETED_DEVICE_FAMILY: "1,2"  # iPhone and iPad
        IPHONEOS_DEPLOYMENT_TARGET: "17.0"
        CODE_SIGN_ENTITLEMENTS: jank-jit.entitlements
        CODE_SIGN_ALLOW_ENTITLEMENTS_MODIFICATION: YES
        # Include paths
        HEADER_SEARCH_PATHS:
          - $(PROJECT_DIR)/../vendor/imgui
          - $(PROJECT_DIR)/../vendor/imgui/backends
          - $(PROJECT_DIR)/../vendor/flecs/distr
          - $(PROJECT_DIR)/../vendor
          - $(PROJECT_DIR)/../vulkan
          - $(PROJECT_DIR)/Frameworks/include
          - $(PROJECT_DIR)/Frameworks/include/SDL3
          - $(PROJECT_DIR)/Frameworks/include/vulkan
          - $(PROJECT_DIR)/Frameworks/include/MoltenVK
          # jank headers
          - /Users/pfeodrippe/dev/jank/compiler+runtime/include/cpp
          - /Users/pfeodrippe/dev/jank/compiler+runtime/src/cpp
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/immer
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/bdwgc/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/bpptree/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/boost-preprocessor/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/boost-multiprecision/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/folly
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/stduuid/include
          # LLVM/Clang headers for JIT (DEVICE version)
          - /Users/pfeodrippe/dev/ios-llvm-build/ios-llvm-device/include
          - /Users/pfeodrippe/dev/jank/compiler+runtime/third-party/cppinterop/include
        FRAMEWORK_SEARCH_PATHS:
          - $(PROJECT_DIR)/Frameworks
        LIBRARY_SEARCH_PATHS:
          # JIT-specific build directory (DEVICE version)
          - $(PROJECT_DIR)/build-iphoneos-jit
          # AOT build directory for libvybe_aot.a
          - $(PROJECT_DIR)/build-iphoneos
        LD_RUNPATH_SEARCH_PATHS:
          - "@executable_path/Frameworks"
        # Linker flags for JIT
        OTHER_LDFLAGS:
          - "-framework Metal"
          - "-framework MetalKit"
          - "-framework QuartzCore"
          - "-framework UIKit"
          - "-framework Foundation"
          - "-framework CoreGraphics"
          - "-framework CoreVideo"
          - "-framework AVFoundation"
          - "-framework GameController"
          - "-framework CoreHaptics"
          - "-framework CoreMotion"
          - "-framework IOSurface"
          - "-framework IOKit"
          - "-lc++"
          # Force load jank symbols for JIT resolution (DEVICE version)
          - "-Wl,-force_load,$(PROJECT_DIR)/build-iphoneos-jit/libjank.a"
          - "-ljankzip"
          - "-lgc"
          - "-lfolly"
          # Full AOT - all modules pre-compiled in a single static library
          # jank_aot_init() creates references to all modules, so no force_load needed
          - "-lvybe_aot"
          # Merged LLVM library (all LLVM/Clang/CppInterOp static libs)
          - "-lllvm_merged"
          # System libraries needed by LLVM
          - "-lcurses"
          - "-lz"
        CODE_SIGN_IDENTITY: "Apple Development"
        CODE_SIGNING_REQUIRED: "YES"
        CODE_SIGNING_ALLOWED: "YES"
    dependencies:
      - framework: Frameworks/MoltenVK.xcframework
        embed: true
      - framework: Frameworks/SDL3.xcframework
        embed: true
    preBuildScripts:
      - name: Compile Shaders
        script: |
          echo "Checking shaders..."
          SHADER_DIR="${PROJECT_DIR}/../vulkan_kim"
          if command -v glslangValidator &> /dev/null; then
            for shader in "$SHADER_DIR"/*.comp; do
              if [ -f "$shader" ]; then
                spv="${shader%.comp}.spv"
                if [ ! -f "$spv" ] || [ "$shader" -nt "$spv" ]; then
                  echo "Compiling $(basename "$shader")..."
                  glslangValidator -V "$shader" -o "$spv"
                fi
              fi
            done
          fi

schemes:
  SdfViewerMobile-JIT-Device:
    build:
      targets:
        SdfViewerMobile-JIT-Device: all
    run:
      config: Debug
    test:
      config: Debug
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
