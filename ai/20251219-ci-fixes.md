# CI Fixes Session

**Date**: 2024-12-19

## Fix 1: Stale PCH (precompiled header) cache

**Problem**: Linux build failed with:
```
fatal error: file 'visit.hpp' has been modified since the precompiled header 'incremental.pch' was built: size changed (was 21452, now 21608)
```

**Root cause**: The PCH cache was using `restore-keys` fallback which restored an older PCH that didn't match the current jank source files. PCH files embed file sizes/timestamps and MUST match exactly.

**Solution**: Remove `restore-keys` fallback for PCH cache:
```yaml
- name: Restore PCH cache
  uses: actions/cache/restore@v4
  with:
    path: ~/jank/compiler+runtime/build/incremental.pch
    key: jank-pch-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v1
    # NO restore-keys fallback! PCH must match exact commit
```

**Lesson**: Never use `restore-keys` fallback for precompiled headers - they are extremely sensitive to source file changes.

## Fix 2: Free disk space (preventive)

Added disk space cleanup step to prevent future issues:
```yaml
- name: Free disk space
  run: |
    sudo rm -rf /usr/share/dotnet          # ~2GB
    sudo rm -rf /usr/local/lib/android     # ~10GB
    sudo rm -rf /opt/ghc                   # ~5GB
    sudo rm -rf /opt/hostedtoolcache/CodeQL
    sudo rm -rf /usr/local/share/boost
    sudo rm -rf /usr/share/swift
    sudo apt-get clean
```

Also reduced swap file from 16GB to 8GB.

## Fix 3: JANK_SRC path not set in CI

**Problem**: Makefile has hardcoded default `JANK_SRC ?= /Users/pfeodrippe/dev/jank/compiler+runtime` but CI clones jank to `~/jank/compiler+runtime`.

**Error**:
```
make: *** No rule to make target `/Users/pfeodrippe/dev/jank/compiler+runtime/include/cpp/jank/type.hpp', needed by `vendor/vybe/vybe_flecs_jank.o'.  Stop.
```

**Solution**: Pass `JANK_SRC` when running make in CI:
```yaml
make test JANK_SRC=$HOME/jank/compiler+runtime
make sdf-standalone JANK_SRC=$HOME/jank/compiler+runtime
```

**Lesson**: Always pass environment-specific paths explicitly in CI rather than relying on defaults.

## Fix 4: Stale jank build cache causing ABI issues

**Problem**: Linux jank build failed with:
```
JIT session error: Symbols not found: [ __emutls_v._ZN4jank7runtime17current_allocatorE ]
```

**Root cause**: Same as Fix 1 - the jank build cache and PCH cache in `build-jank-linux` job were using `restore-keys` fallback, restoring older artifacts that caused ABI incompatibilities when mixed with newer source code.

**Solution**: Remove `restore-keys` from both caches and bump version:
```yaml
- name: Cache jank build
  uses: actions/cache@v4
  with:
    path: |
      ~/jank/compiler+runtime/build/jank
      ...
    key: jank-build-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v10
    # NO restore-keys!

- name: Cache PCH
  uses: actions/cache@v4
  with:
    path: ~/jank/compiler+runtime/build/incremental.pch
    key: jank-pch-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v2
    # NO restore-keys!
```

**Lesson**: Never use `restore-keys` for C++ build artifacts - partial/stale caches cause hard-to-debug ABI issues. Always require exact cache key match.

## Fix 5: Force fresh Clang/LLVM build

**Problem**: Even after fixing cache fallbacks, Linux still fails with same error. Might be stale Clang cache.

**Solution**: Bump Clang cache version to force fresh build:
```yaml
key: clang-linux-x64-${{ env.JANK_REF }}-v2  # was v1
```

## Fix 6: Cache key mismatches between build-jank-linux and build-linux jobs

**Problem**: The `build-linux` job was restoring old cache versions that didn't match what `build-jank-linux` built:
- Clang: `build-jank-linux` saves with `v2`, but `build-linux` restored `v1`
- jank build: `build-jank-linux` saves with `v10`, but `build-linux` restored `v9` AND had `restore-keys` fallback
- PCH: `build-jank-linux` saves with `v2`, but `build-linux` restored `v1`

**Root cause**: When cache keys don't match, GitHub Actions can't find the exact cache, resulting in either:
1. No cache restored (cache miss)
2. Older cache restored via `restore-keys` fallback (stale artifacts)

**Solution**: Align all cache keys in `build-linux` with `build-jank-linux`:
```yaml
# Clang
key: clang-linux-x64-${{ env.JANK_REF }}-v2

# jank build - REMOVED restore-keys fallback
key: jank-build-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v10

# PCH
key: jank-pch-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v2
```

**Lesson**: Cache keys between producer and consumer jobs MUST match exactly. Always verify cache version alignment after bumping versions.

## Fix 7: Inconsistent jank configure flags between macOS and Linux

**Problem**: Linux jank build uses `-Djank_local_clang=on` while macOS uses `-Dllvm_dir=...`, causing different LLVM/TLS handling:

```yaml
# macOS (working)
./bin/configure -GNinja -DCMAKE_BUILD_TYPE=Release \
  -Dllvm_dir=$HOME/jank/compiler+runtime/build/llvm-install/usr/local

# Linux (failing with TLS symbol error)
./bin/configure -GNinja -DCMAKE_BUILD_TYPE=Release \
  -Djank_local_clang=on
```

**Root cause**: The `__emutls_v._ZN4jank7runtime17current_allocatorE` error suggests Linux is using emulated TLS differently. The `-Djank_local_clang=on` flag might configure LLVM differently than explicit `-Dllvm_dir`.

**Solution**: Use same configure flags as macOS:
```yaml
./bin/configure -GNinja -DCMAKE_BUILD_TYPE=Release \
  -Dllvm_dir=$HOME/jank/compiler+runtime/build/llvm-install/usr/local
```

Also bumped cache versions to force fresh build:
- jank build: v10 → v11
- PCH: v2 → v3

**Lesson**: Keep build configurations consistent across platforms when possible. Different CMake flags can cause subtle ABI/linking differences.
