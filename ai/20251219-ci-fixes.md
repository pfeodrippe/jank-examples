# CI Fixes Session

**Date**: 2024-12-19

## Fix 1: Stale PCH (precompiled header) cache

**Problem**: Linux build failed with:
```
fatal error: file 'visit.hpp' has been modified since the precompiled header 'incremental.pch' was built: size changed (was 21452, now 21608)
```

**Root cause**: The PCH cache was using `restore-keys` fallback which restored an older PCH that didn't match the current jank source files. PCH files embed file sizes/timestamps and MUST match exactly.

**Solution**: Remove `restore-keys` fallback for PCH cache:
```yaml
- name: Restore PCH cache
  uses: actions/cache/restore@v4
  with:
    path: ~/jank/compiler+runtime/build/incremental.pch
    key: jank-pch-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v1
    # NO restore-keys fallback! PCH must match exact commit
```

**Lesson**: Never use `restore-keys` fallback for precompiled headers - they are extremely sensitive to source file changes.

## Fix 2: Free disk space (preventive)

Added disk space cleanup step to prevent future issues:
```yaml
- name: Free disk space
  run: |
    sudo rm -rf /usr/share/dotnet          # ~2GB
    sudo rm -rf /usr/local/lib/android     # ~10GB
    sudo rm -rf /opt/ghc                   # ~5GB
    sudo rm -rf /opt/hostedtoolcache/CodeQL
    sudo rm -rf /usr/local/share/boost
    sudo rm -rf /usr/share/swift
    sudo apt-get clean
```

Also reduced swap file from 16GB to 8GB.
