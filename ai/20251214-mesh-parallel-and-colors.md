# Mesh Parallel Processing and Colors/UVs - Dec 14, 2025

## Summary
Completed implementation of parallel marching cubes and optional vertex colors/UVs for mesh export.

## Changes Made

### 1. Parallel Marching Cubes (`vulkan/marching_cubes.hpp`)
Complete rewrite with multi-threaded mesh generation:

**New includes:**
- `<thread>`, `<mutex>`, `<atomic>` for parallelism

**Extended Vec3 with:**
- `dot()`, `cross()`, `length()`, `normalized()` methods for normal computation

**New structs:**
```cpp
struct Vec2 { float u, v; };
struct Color3 { float r, g, b; };
struct Vertex { Vec3 pos; Vec3 normal; Color3 color; Vec2 uv; };
struct ThreadMesh { std::vector<Vec3> vertices; std::vector<uint32_t> indices; };
```

**Extended Mesh struct:**
```cpp
struct Mesh {
    std::vector<Vec3> vertices;
    std::vector<Vec3> normals;
    std::vector<Color3> colors;
    std::vector<Vec2> uvs;
    std::vector<uint32_t> indices;
    bool hasColors() const;
    bool hasUVs() const;
    bool hasNormals() const;
};
```

**New functions:**
- `generateMesh()` - Parallelized using `std::thread`, splits Z-slices across CPU threads
- `computeNormals()` - Computes per-vertex normals from triangle geometry
- `computeUVs()` - Triplanar UV mapping based on surface normal direction
- `triplanarUV()` - Helper for UV computation
- `setUniformColor(mesh, r, g, b)` - Set all vertices to same color
- `setColors(mesh, colors)` - Set per-vertex colors from vector

**Updated `exportOBJ()`:**
```cpp
bool exportOBJ(const std::string& filename, const Mesh& mesh,
               bool includeColors = false, bool includeUVs = false);
```

OBJ output now supports:
- Vertex colors (appended to `v` lines as `v x y z r g b`)
- Texture coordinates (`vt u v`)
- Vertex normals (`vn nx ny nz`)
- Face format adapts: `f v` / `f v/vt` / `f v//vn` / `f v/vt/vn`

### 2. Updated Export Functions (`vulkan/sdf_engine.hpp`)
Modified `export_scene_mesh_gpu()` overloads to support new features:

```cpp
// Full overload with bounds
MeshExportResult export_scene_mesh_gpu(
    const char* filepath,
    float minX, float minY, float minZ,
    float maxX, float maxY, float maxZ,
    int resolution,
    bool includeColors = false,
    bool includeUVs = false
);

// Simple overload using stored mesh
MeshExportResult export_scene_mesh_gpu(
    const char* filepath,
    int resolution = 64,
    bool includeColors = false,
    bool includeUVs = false
);
```

Both now:
- Compute normals automatically (always useful)
- Optionally compute UVs with triplanar mapping
- Set default gray color (0.8, 0.8, 0.8) if colors requested but not set
- Pass color/UV flags to `exportOBJ()`

## Build Issue Fixed
Fixed syntax error where `setUniformColor()` was being called with `Color3` struct instead of separate `float r, g, b` parameters:
```cpp
// Wrong:
mc::setUniformColor(mesh, mc::Color3{0.8f, 0.8f, 0.8f});
// Correct:
mc::setUniformColor(mesh, 0.8f, 0.8f, 0.8f);
```

## Testing
- Build successful with `make sdf`
- Mesh preview generated: 11,676 vertices, 3,892 triangles at 576 resolution
- OBJ export confirmed working with correct formatting (no locale issues)
- Header shows "Generated by Marching Cubes (Parallel)"

## Files Modified
- `vulkan/marching_cubes.hpp` - Complete rewrite with parallelism, colors, UVs
- `vulkan/sdf_engine.hpp` - Updated export functions with color/UV parameters
- `src/vybe/sdf/ui.jank` - Added checkboxes for export options

## UI Changes (`src/vybe/sdf/ui.jank`)
Added export option checkboxes using proper jank/imgui interop:

```clojure
;; State variables (using v->p for mutable bool pointers)
(defonce *export-colors (u/v->p false))
(defonce *export-uvs (u/v->p false))

;; In draw-debug-ui!:
(imgui/Checkbox "Include Colors" (cpp/unbox *export-colors))
(imgui/Checkbox "Include UVs" (cpp/unbox *export-uvs))

;; Export call with options:
(let [inc-colors (u/p->v *export-colors)
      inc-uvs (u/p->v *export-uvs)]
  (sdfx/export_scene_mesh_gpu "exported_scene.obj" (cpp/int. res)
                               inc-colors inc-uvs))
```

## Blender Verification
Successfully verified in Blender:
- Vertex color layer imported: "Color"
- UV layer imported: "UVMap"
- Mesh renders correctly with applied colors

## Completed
- Parallel marching cubes with std::thread
- Optional vertex colors in OBJ export
- Optional UV coordinates (triplanar mapping)
- UI checkboxes for export options
- Blender verification of all features

## Future Enhancement
- Sample shader material colors at vertices for more interesting exports
- Add texture baking option for UV-mapped textures
