# Fix Plan: Tests and Standalone Initialization

**Date:** 2025-12-12

## Problem 1: Tests Broken (`__next_prime overflow`)

The tests were passing before but now crash. This means something in the recent changes broke them.

### Recent Changes That Could Have Caused This:
1. Modified `flecs.jank` to use header includes instead of cpp/raw
2. Added `vybe_flecs_jank.o` object file
3. Modified `run_tests.sh` to add build dependencies

### Investigation Steps:
1. Check if the `vybe_flecs_jank.o` is being compiled with correct flags
2. Check if there's a symbol conflict or duplicate definition
3. Verify the static `std::unordered_map` in `vybe_flecs_jank.cpp` is initialized correctly
4. Test if reverting to cpp/raw in flecs.jank fixes the issue

### Likely Root Cause:
The static `std::unordered_map<ecs_entity_t, jank::runtime::object_ref> vybe_system_callbacks` in `vybe_flecs_jank.cpp` may not be properly initialized when loaded as an object file during JIT.

### Fix Approach:
1. Check if vybe_flecs_jank.o needs to be recompiled
2. Ensure the hash map is properly initialized before use
3. Consider using a different data structure or initialization pattern

## Problem 2: Standalone Initialization

The standalone app can't find headers at runtime because include paths are baked in during compilation.

### Fix Approach:
1. Use absolute paths during compilation that point to a location we control
2. Create the expected directory structure in the app bundle
3. Or: Bundle jank's include search in the standalone

## Implementation Order:
1. First fix the tests (higher priority - was working before)
2. Then fix standalone initialization
