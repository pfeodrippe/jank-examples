# iOS JIT: const char* nullptr Fix and Remaining Symbol/Nil Issue

**Date:** 2026-01-02

## What I Fixed

### 1. const char* nullptr Conversion Bug (builtin.hpp)

**File:** `/Users/pfeodrippe/dev/jank/compiler+runtime/include/cpp/jank/runtime/convert/builtin.hpp`

**Problem:** The `convert<const char*>::into_object` function had a type mismatch:
```cpp
// BEFORE (BUG):
static obj::persistent_string_ref into_object(char const * const o)
{
  if(o == nullptr)
  {
    return jank_nil();  // Returns nil_ref but function signature promises persistent_string_ref!
  }
  return make_box(o);
}
```

**Fix:** Return an empty string instead of nil to match Clojure semantics (`(str nil)` returns `""`):
```cpp
// AFTER (FIXED):
static obj::persistent_string_ref into_object(char const * const o)
{
  if(o == nullptr)
  {
    return make_box("");  // Returns empty string, matching return type
  }
  return make_box(o);
}
```

## Remaining Issue: vybe.util Symbol/Nil Crash

The crash persists during vybe.util module loading:
```
[loader] Phase 2 - Calling entry function for: vybe.util
Exception caught while destructing binding_scope
[jank] Error calling -main: invalid object type (expected symbol found nil)
```

### What Works
- vybe.sdf.math loads successfully
- vybe.sdf.state loads successfully

### What Fails
- vybe.util crashes during entry function execution

### Analysis
The error "expected symbol found nil" is generated by `try_object<symbol>()` when:
1. Code expects a symbol object
2. But receives a nil object

This happens somewhere in the binding/var machinery during vybe.util loading. The `binding_scope` destructor catches an exception from `pop_thread_bindings()`.

### Already Fixed (Previous Session)
The void/object* cast mismatches were fixed in:
1. `loader.cpp:1028-1029` - Phase 1 load_o function
2. `loader.cpp:1214-1217` - Phase 2 entry function calls
3. `context.cpp:271-285` - iOS JIT remote eval path
4. `c_api.cpp:36` - Declaration mismatch
5. `aot/processor.cpp:794` - Declaration mismatch
6. `ios-bundle:599 and :800` - Script declarations

### Next Steps to Investigate
1. The crash may be in the require machinery for clojure.string
2. Check if there's a macro expansion issue in vybe.util
3. Look at binding_scope push/pop for potential issues
4. The error could be in `push_thread_bindings()` when iterating bindings

### Investigated but Not Yet Fixed
- Generated code for vybe.util appears correct
- Entry function properly initializes all var_refs and constants
- The crash happens during `clojure_core_ns_load_76003_76004::call()` execution
- Functions that call `try_object<symbol>`:
  - `intern_var(sym)` at core_native.cpp:93
  - `in_ns(sym)` at core_native.cpp:214, 219
  - `intern_ns(sym)` at core_native.cpp:246
  - `find_ns(sym)` at core_native.cpp:251
  - `find_var(sym)` at core_native.cpp:256
  - Many more in namespace/alias handling

The crash happens when one of these functions receives nil instead of a symbol object.

## Commands Ran

```bash
# Rebuild jank compiler
cd /Users/pfeodrippe/dev/jank/compiler+runtime
SDKROOT=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX15.1.sdk \
CC=$PWD/build/llvm-install/usr/local/bin/clang \
CXX=$PWD/build/llvm-install/usr/local/bin/clang++ \
./bin/compile

# Rebuild iOS JIT library
make ios-jit-sim

# Test iOS JIT app
make ios-jit-sim-run
```

## Files Modified

1. `/Users/pfeodrippe/dev/jank/compiler+runtime/include/cpp/jank/runtime/convert/builtin.hpp` - Fixed nullptr returning wrong type (lines 249-251)

## Result

- **FIXED**: const char* nullptr conversion now returns empty string instead of nil
- **STILL BROKEN**: vybe.util loading crashes with "expected symbol found nil"
- The nullptr fix was correct but doesn't address the vybe.util crash
- Need further investigation into the symbol/nil crash
