# iOS AOT nREPL Fix - 2025-12-25

## Problem
`make sdf-ios-sim-run` was failing with linker error:
```
Undefined symbols for architecture arm64:
  "_jank_load_jank_nrepl_server_asio", referenced from:
      _jank_aot_init in libvybe_aot.a[8](jank_aot_init.o)
```

## Root Cause
The `jank_aot_init.cpp` (auto-generated by jank's `ios-bundle` script) was hardcoded to always load the nREPL server module, even though nREPL is only needed for JIT mode, not pure AOT builds.

## Fix
Wrapped the nREPL loading in `#if defined(JANK_IOS_JIT)` in `/Users/pfeodrippe/dev/jank/compiler+runtime/bin/ios-bundle`:

```cpp
// nREPL native module loader (only for JIT mode)
#if defined(JANK_IOS_JIT)
extern "C" void* jank_load_jank_nrepl_server_asio();
#endif

// ... inside jank_aot_init():

#if defined(JANK_IOS_JIT)
    // Load nREPL native module AFTER core libs but BEFORE user modules
    std::cout << "[jank] Loading nREPL native module..." << std::endl;
    jank_load_jank_nrepl_server_asio();
    jank_module_set_loaded("jank.nrepl-server.asio");
#endif
```

This way:
- **AOT builds** (no `JANK_IOS_JIT`): nREPL code is excluded
- **JIT builds** (`JANK_IOS_JIT=1`): nREPL code is included

## Key Files
- `/Users/pfeodrippe/dev/jank/compiler+runtime/bin/ios-bundle` - generates `jank_aot_init.cpp`
- `SdfViewerMobile/project-jit-*.yml` - define `JANK_IOS_JIT=1` for JIT builds

## Commands Used
```bash
# Diagnosis
nm /Users/pfeodrippe/dev/something/SdfViewerMobile/build-iphonesimulator/libjank.a | grep nrepl
grep -n "JANK_IOS_JIT" /Users/pfeodrippe/dev/something/SdfViewerMobile/*.mm

# JIT builds have nREPL in libjank.a:
nm /Users/pfeodrippe/dev/jank/compiler+runtime/build-ios-sim-jit/libjank.a | grep nrepl
```

## Additional Fix: Makefile JIT PCH Target

Also fixed the Makefile to automatically rebuild the precompiled header (PCH) when jank headers change:

1. Added `ios-jit-pch` target that runs `./SdfViewerMobile/build-ios-pch.sh`
2. Fixed duplicate `ios-jit-sim-run` target (renamed first one to `ios-jit-sim-build`)
3. Added `ios-jit-pch` as dependency of `ios-jit-sim-build`

```makefile
# Build precompiled header for iOS JIT (rebuilds when jank headers change)
.PHONY: ios-jit-pch
ios-jit-pch: ios-jit-sync-includes
	@echo "Building iOS JIT precompiled header..."
	./SdfViewerMobile/build-ios-pch.sh

.PHONY: ios-jit-sim-build
ios-jit-sim-build: ios-jit-sync-sources ios-jit-pch ios-jit-sim-project
	...
```

## Commands
```bash
# AOT build (no nREPL)
make sdf-ios-sim-run

# JIT build (with nREPL, rebuilds PCH automatically)
make ios-jit-sim-run
```

## CI Update

Added iOS simulator builds as parallel GitHub Actions jobs in `.github/workflows/ci.yml`:

```
                    ┌─► build-macos (Tests + Standalone)
                    │
build-jank-macos ───┼─► build-ios-aot (iOS AOT Simulator)
                    │
                    └─► build-ios-jit (iOS JIT Simulator)
```

All three jobs have `needs: [get-jank-commit, build-jank-macos]` so they run in parallel.

## Removed Hardcoded Paths

Updated iOS build scripts to require `JANK_SRC` environment variable (no hardcoded fallbacks):
- `SdfViewerMobile/build_ios_jank_aot.sh`
- `SdfViewerMobile/build_ios_jank.sh`
- `SdfViewerMobile/build_ios_jit.sh`
- `SdfViewerMobile/build-ios-pch.sh`

Makefile passes `JANK_SRC` to scripts: `JANK_SRC=$(JANK_SRC) ./script.sh`
