name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  JANK_REPO: pfeodrippe/jank
  JANK_REF: nrepl
  HOMEBREW_NO_AUTO_UPDATE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Get jank commit hash for caching
  # ============================================================================
  get-jank-commit:
    name: Get jank commit hash
    runs-on: ubuntu-latest
    outputs:
      commit: ${{ steps.get-commit.outputs.commit }}
    steps:
      - name: Get jank commit hash
        id: get-commit
        run: |
          COMMIT=$(git ls-remote https://github.com/${{ env.JANK_REPO }}.git refs/heads/${{ env.JANK_REF }} | cut -f1)
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "jank commit: $COMMIT"

  # ============================================================================
  # macOS Pipeline (runs in parallel with Linux)
  # ============================================================================
  build-jank-macos:
    name: Build jank - macOS
    needs: get-jank-commit
    runs-on: macos-14
    timeout-minutes: 200
    steps:
      - name: Clone jank
        run: |
          git clone --depth 1 --recurse-submodules --branch ${{ env.JANK_REF }} https://github.com/${{ env.JANK_REPO }}.git ~/jank

      - name: Install Homebrew deps
        run: |
          brew install git pkg-config ninja python cmake zlib double-conversion boost openssl doctest

      # Cache 1: Clang/LLVM (rarely changes, keyed by branch)
      - name: Cache Clang/LLVM
        id: cache-clang
        uses: actions/cache@v4
        with:
          path: ~/jank/compiler+runtime/build/llvm-install
          key: clang-macos-arm64-${{ env.JANK_REF }}-v1

      - name: Build Clang/LLVM
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"
          cd ~/jank/compiler+runtime
          ./bin/build-clang
          ~/jank/compiler+runtime/build/llvm-install/usr/local/bin/clang++ --version

      # Cache 2: jank build (keyed by commit hash)
      - name: Cache jank build
        id: cache-jank
        uses: actions/cache@v4
        with:
          path: |
            ~/jank/compiler+runtime/build/jank
            ~/jank/compiler+runtime/build/CMakeCache.txt
            ~/jank/compiler+runtime/build/CMakeFiles
            ~/jank/compiler+runtime/build/*.a
            ~/jank/compiler+runtime/build/*.ninja
            ~/jank/compiler+runtime/build/lib
          key: jank-build-macos-arm64-${{ needs.get-jank-commit.outputs.commit }}-v2

      - name: Build jank
        if: steps.cache-jank.outputs.cache-hit != 'true'
        run: |
          export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"
          export CC=$HOME/jank/compiler+runtime/build/llvm-install/usr/local/bin/clang
          export CXX=$HOME/jank/compiler+runtime/build/llvm-install/usr/local/bin/clang++
          cd ~/jank/compiler+runtime
          ./bin/configure -GNinja -DCMAKE_BUILD_TYPE=Release \
            -Dllvm_dir=$HOME/jank/compiler+runtime/build/llvm-install/usr/local
          ./bin/compile
          echo "jank build complete"
          ~/jank/compiler+runtime/build/jank check-health

  build-macos:
    name: Build and Test - macOS
    needs: [get-jank-commit, build-jank-macos]
    runs-on: macos-14
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure submodules are initialized
        run: |
          git submodule update --init --recursive
          ls -la vendor/JoltPhysics/CMakeLists.txt || echo "WARNING: JoltPhysics not properly cloned"

      - name: Clone jank (for source files)
        run: |
          git clone --depth 1 --recurse-submodules --branch ${{ env.JANK_REF }} https://github.com/${{ env.JANK_REPO }}.git ~/jank

      - name: Install Homebrew deps
        run: |
          brew install cmake ninja double-conversion pkg-config llvm ccache boost openssl zlib doctest
          brew install openssl@3 zstd sdl3 vulkan-loader shaderc molten-vk

      - name: Restore Clang/LLVM cache
        uses: actions/cache/restore@v4
        with:
          path: ~/jank/compiler+runtime/build/llvm-install
          key: clang-macos-arm64-${{ env.JANK_REF }}-v1

      - name: Restore jank build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/jank/compiler+runtime/build/jank
            ~/jank/compiler+runtime/build/CMakeCache.txt
            ~/jank/compiler+runtime/build/CMakeFiles
            ~/jank/compiler+runtime/build/*.a
            ~/jank/compiler+runtime/build/*.ninja
            ~/jank/compiler+runtime/build/lib
          key: jank-build-macos-arm64-${{ needs.get-jank-commit.outputs.commit }}-v2

      - name: Verify jank
        run: |
          ~/jank/compiler+runtime/build/jank check-health

      - name: Set up environment
        run: |
          echo "$HOME/jank/compiler+runtime/build" >> $GITHUB_PATH

      - name: Run tests
        run: |
          export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"
          export PATH="$HOME/jank/compiler+runtime/build:$PATH"
          make test

      - name: Build standalone app
        run: |
          export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"
          export PATH="$HOME/jank/compiler+runtime/build:$PATH"
          make sdf-standalone

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: SDFViewer-macOS
          path: SDFViewer.dmg
          if-no-files-found: error

  # ============================================================================
  # Linux Pipeline (runs in parallel with macOS)
  # ============================================================================
  build-jank-linux:
    name: Build jank - Linux
    needs: get-jank-commit
    runs-on: ubuntu-24.04
    timeout-minutes: 200
    steps:
      - name: Clone jank
        run: |
          git clone --depth 1 --recurse-submodules --branch ${{ env.JANK_REF }} https://github.com/${{ env.JANK_REPO }}.git ~/jank

      - name: Install apt deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git build-essential libssl-dev libdouble-conversion-dev \
            pkg-config ninja-build cmake zlib1g-dev libffi-dev libboost-dev libboost-system-dev \
            doctest-dev libgc-dev

      # Cache 1: Clang/LLVM (rarely changes, keyed by branch)
      - name: Cache Clang/LLVM
        id: cache-clang
        uses: actions/cache@v4
        with:
          path: ~/jank/compiler+runtime/build/llvm-install
          key: clang-linux-x64-${{ env.JANK_REF }}-v1

      - name: Build Clang/LLVM
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          cd ~/jank/compiler+runtime
          ./bin/build-clang
          ~/jank/compiler+runtime/build/llvm-install/usr/local/bin/clang++ --version

      # Cache 2: jank build (keyed by commit hash)
      - name: Cache jank build
        id: cache-jank
        uses: actions/cache@v4
        with:
          path: |
            ~/jank/compiler+runtime/build/jank
            ~/jank/compiler+runtime/build/CMakeCache.txt
            ~/jank/compiler+runtime/build/CMakeFiles
            ~/jank/compiler+runtime/build/*.a
            ~/jank/compiler+runtime/build/*.o
            ~/jank/compiler+runtime/build/**/*.o
            ~/jank/compiler+runtime/build/*.ninja
            ~/jank/compiler+runtime/build/lib
          key: jank-build-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v9
          restore-keys: |
            jank-build-linux-x64-

      # Cache 3: PCH separately (takes 1h30 to build)
      # Use commit-based key with branch fallback to avoid full rebuilds
      - name: Cache PCH
        id: cache-pch
        uses: actions/cache@v4
        with:
          path: ~/jank/compiler+runtime/build/incremental.pch
          key: jank-pch-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v1
          restore-keys: |
            jank-pch-linux-x64-

      - name: Create swap space
        if: steps.cache-jank.outputs.cache-hit != 'true' || steps.cache-pch.outputs.cache-hit != 'true'
        run: |
          # Create 8GB swap to handle PCH generation memory requirements
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Build jank
        if: steps.cache-jank.outputs.cache-hit != 'true' || steps.cache-pch.outputs.cache-hit != 'true'
        run: |
          export CC=$HOME/jank/compiler+runtime/build/llvm-install/usr/local/bin/clang
          export CXX=$HOME/jank/compiler+runtime/build/llvm-install/usr/local/bin/clang++
          cd ~/jank/compiler+runtime
          # Use same flags as jank's CI
          ./bin/configure -GNinja -DCMAKE_BUILD_TYPE=Release \
            -Djank_local_clang=on
          ./bin/compile
          echo "jank build complete"
          ~/jank/compiler+runtime/build/jank check-health

  build-linux:
    name: Build and Test - Linux
    needs: [get-jank-commit, build-jank-linux]
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          # Remove large pre-installed tools we don't need
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          # Clean apt cache
          sudo apt-get clean
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Create swap space
        run: |
          # 8GB swap for jank AOT compilation (reduced to save disk space)
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h
          df -h

      - name: Clone jank (for source files)
        run: |
          git clone --depth 1 --recurse-submodules --branch ${{ env.JANK_REF }} https://github.com/${{ env.JANK_REPO }}.git ~/jank

      - name: Install apt deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git build-essential libssl-dev libdouble-conversion-dev \
            pkg-config ninja-build cmake zlib1g-dev libffi-dev libboost-dev libboost-system-dev \
            doctest-dev libgc-dev ccache patchelf
          # Vulkan deps (SDL3 built from source below)
          sudo apt-get install -y libvulkan-dev glslang-tools libshaderc-dev libshaderc1
          # X11/Wayland deps for SDL3
          sudo apt-get install -y libx11-dev libxext-dev libxrandr-dev libxcursor-dev libxi-dev libxss-dev

      - name: Cache SDL3
        id: cache-sdl3
        uses: actions/cache@v4
        with:
          path: ~/SDL3-install
          key: sdl3-linux-x64-3.2.x-v2
          save-always: true

      - name: Build SDL3 from source
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          # SDL3 not in Ubuntu 24.04 repos, build from source
          git clone --depth 1 --branch release-3.2.x https://github.com/libsdl-org/SDL.git ~/SDL3
          cd ~/SDL3
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/SDL3-install
          cmake --build build -j$(nproc)
          cmake --install build

      - name: Install SDL3
        run: |
          sudo cp -r ~/SDL3-install/* /usr/local/
          sudo ldconfig

      - name: Restore Clang/LLVM cache
        uses: actions/cache/restore@v4
        with:
          path: ~/jank/compiler+runtime/build/llvm-install
          key: clang-linux-x64-${{ env.JANK_REF }}-v1

      - name: Restore jank build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/jank/compiler+runtime/build/jank
            ~/jank/compiler+runtime/build/CMakeCache.txt
            ~/jank/compiler+runtime/build/CMakeFiles
            ~/jank/compiler+runtime/build/*.a
            ~/jank/compiler+runtime/build/*.o
            ~/jank/compiler+runtime/build/**/*.o
            ~/jank/compiler+runtime/build/*.ninja
            ~/jank/compiler+runtime/build/lib
          key: jank-build-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v9
          restore-keys: |
            jank-build-linux-x64-

      - name: Restore PCH cache
        uses: actions/cache/restore@v4
        with:
          path: ~/jank/compiler+runtime/build/incremental.pch
          key: jank-pch-linux-x64-${{ needs.get-jank-commit.outputs.commit }}-v1
          # NO restore-keys fallback! PCH must match exact commit or it will fail with
          # "file has been modified since the precompiled header was built"

      - name: Verify jank
        run: |
          ~/jank/compiler+runtime/build/jank check-health

      - name: Set up environment
        run: |
          echo "$HOME/jank/compiler+runtime/build" >> $GITHUB_PATH

      - name: Run tests
        run: |
          export PATH="$HOME/jank/compiler+runtime/build:$PATH"
          make test

      - name: Build standalone app
        run: |
          export PATH="$HOME/jank/compiler+runtime/build:$PATH"
          echo "=== Starting build at $(date) ==="
          echo "=== Memory status ==="
          free -h
          echo "=== Running full standalone build ==="
          time make sdf-standalone
          echo "=== Build complete at $(date) ==="

      - name: Upload Linux tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: SDFViewer-Linux
          path: SDFViewer-linux.tar.gz
          if-no-files-found: error
